<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AllSet - Dashboard de Chamados</title>
    <link rel="icon" type="image/png" href="../assets/img/logoAllSet.png" />
    <link rel="stylesheet" href="../css/dashboardsChamados.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>

    </style>
</head>

<body>
    <div class="dashboard">
        <div class="header">
            <div class="title">Dashboard de Chamados JIRA - Vis√£o Global</div>
        </div>

        <!-- KPIs Globais -->
        <div class="kpi-container">
            <div class="kpi-card">
                <div class="kpi-title">Lote com mais chamados em aberto</div>
                <div class="kpi-value" id="kpi-lote-mais-chamados">Carregando...</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Total de chamados em aberto</div>
                <div class="kpi-value" id="kpi-total-aberto">Carregando...</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Finalizados nas √∫ltimas 24h</div>
                <div class="kpi-value" id="kpi-resolvidos-24">Carregando...</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Tempo m√©dio de resolu√ß√£o</div>
                <div class="kpi-value" id="kpi-tempo-medio">Carregando...</div>
            </div>
        </div>


        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Chamados em Aberto (Ordenados por Urg√™ncia)</h3>
            </div>
            <table class="chamados-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Lote</th>
                        <th>Descri√ß√£o</th>
                        <th>Data de Cria√ß√£o</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tabela-chamados">
                    <tr>
                        <td colspan="5" class="loading">üîÑ Carregando chamados...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Filtros -->
        <div class="filters">
            <div class="filter-group">
                <label for="lote">Filtrar por Lote:</label>
                <select id="lote">
                    <option value="">üîÑ Carregando lotes...</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Per√≠odo do Gr√°fico:</label>
                <div class="periodo-buttons">
                    <button class="periodo-btn active" data-dias="7">7 dias</button>
                    <button class="periodo-btn" data-dias="15">15 dias</button>
                    <button class="periodo-btn" data-dias="30">30 dias</button>
                </div>
            </div>

            <button class="refresh-btn" onclick="atualizarTudo()">üîÑ Atualizar Dados</button>
        </div>

        <!-- Gr√°fico -->
        <div class="chart-container">
            <h3 id="chart-title">Gr√°fico de Chamados nos √∫ltimos 7 dias - Todos os lotes</h3>

            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-title">Chamados em aberto (filtro)</div>
                    <div class="metric-value" id="metric-total-aberto">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Finalizados (filtro)</div>
                    <div class="metric-value" id="metric-total-finalizados">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">√çndice de conclus√£o</div>
                    <div class="metric-value" id="metric-indice-conclusao">0%</div>
                </div>
            </div>

            <div class="chart-wrapper">
                <canvas id="chamadosChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let chamadosChart;

        // Formatar data para o padr√£o brasileiro
        function formatarDataBR(dataISO) {
            try {
                return new Date(dataISO).toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (error) {
                return 'Data inv√°lida';
            }
        }

        // Fun√ß√£o para obter classe CSS do status
        function obterClasseStatus(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('progresso') || statusLower.includes('progress')) {
                return 'status-em-progresso';
            } else if (statusLower.includes('novo') || statusLower.includes('new')) {
                return 'status-novo';
            } else if (statusLower.includes('pendente') || statusLower.includes('pending')) {
                return 'status-pendente';
            }
            return 'status-default';
        }

        // Atualizar KPIs globais
        async function atualizarKPIsGlobais() {
            console.log('üîÑ Buscando KPIs globais...');

            try {
                const response = await axios.get('/jira/kpis-globais');
                const kpis = response.data;

                console.log('üìä KPIs globais recebidos:', kpis);

                // Atualizar elementos na tela
                document.getElementById('kpi-lote-mais-chamados').textContent = kpis.loteComMais || 'N/A';
                document.getElementById('kpi-total-aberto').textContent = kpis.totalAbertos || '0';
                document.getElementById('kpi-resolvidos-24').textContent = kpis.finalizadosUltimas24h || '0';
                document.getElementById('kpi-tempo-medio').textContent = kpis.tempoMedioResolucao || 'N/A';

                return kpis;
            } catch (error) {
                console.error('‚ùå Erro ao buscar KPIs globais:', error);

                // Mostrar erro na interface
                document.getElementById('kpi-lote-mais-chamados').textContent = 'Erro';
                document.getElementById('kpi-total-aberto').textContent = 'Erro';
                document.getElementById('kpi-resolvidos-24').textContent = 'Erro';
                document.getElementById('kpi-tempo-medio').textContent = 'Erro';

                return {};
            }
        }

        // Atualizar tabela de chamados globais
        async function atualizarTabelaChamados() {
            console.log('üîÑ Buscando chamados globais...');

            const tabelaBody = document.getElementById('tabela-chamados');
            tabelaBody.innerHTML = '<tr><td colspan="5" class="loading">üîÑ Carregando chamados...</td></tr>';

            try {
                const response = await axios.get('/jira/chamados-globais');
                const chamados = response.data;

                console.log('üìã Chamados globais recebidos:', chamados?.length || 0);

                if (!chamados || chamados.length === 0) {
                    tabelaBody.innerHTML = '<tr><td colspan="5" class="loading">üì≠ Nenhum chamado em aberto encontrado</td></tr>';
                    return [];
                }

                // Limpar tabela e adicionar chamados
                tabelaBody.innerHTML = '';
                chamados.forEach((chamado, index) => {
                    const statusClass = obterClasseStatus(chamado.status);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>#${chamado.id}</strong></td>
                        <td>${chamado.lote || 'N/A'}</td>
                        <td>${chamado.descricao || 'Sem descri√ß√£o'}</td>
                        <td>${formatarDataBR(chamado.data)}</td>
                        <td><span class="status-badge ${statusClass}">${chamado.status}</span></td>
                    `;
                    tabelaBody.appendChild(row);
                });

                console.log('‚úÖ Tabela atualizada com', chamados.length, 'chamados');
                return chamados;

            } catch (error) {
                console.error('‚ùå Erro ao buscar chamados globais:', error);
                tabelaBody.innerHTML = '<tr><td colspan="5" class="error">‚ùå Erro ao carregar chamados. Verifique a conex√£o.</td></tr>';
                return [];
            }
        }

        // Carregar lotes dispon√≠veis
        async function carregarLotes() {
            console.log('üîÑ Carregando lotes dispon√≠veis...');

            const select = document.getElementById('lote');

            try {
                const response = await axios.get('/jira/lotes');
                const lotes = response.data.lotes || [];

                console.log('üì¶ Lotes carregados:', lotes);

                // Limpar e popular select
                select.innerHTML = '<option value="">üìä Todos os lotes</option>';

                lotes.forEach(lote => {
                    const option = document.createElement('option');
                    option.value = lote;
                    option.textContent = lote;
                    select.appendChild(option);
                });

                console.log('‚úÖ Select de lotes populado');
                return lotes;

            } catch (error) {
                console.error('‚ùå Erro ao carregar lotes:', error);
                select.innerHTML = '<option value="">‚ùå Erro ao carregar lotes</option>';
                return [];
            }
        }

        // Atualizar gr√°fico
        async function atualizarGrafico() {
            const lote = document.getElementById('lote').value;
            const dias = parseInt(document.querySelector('.periodo-btn.active').dataset.dias);

            console.log(`üìà Atualizando gr√°fico - Lote: ${lote || 'Todos'}, Per√≠odo: ${dias} dias`);

            try {
                // Buscar dados do gr√°fico
                const responseGrafico = await axios.get(`/jira/grafico?lote=${encodeURIComponent(lote || '')}&periodo=${dias}`);
                const dadosGrafico = responseGrafico.data;

                // Buscar KPIs do filtro
                const responseKPIs = await axios.get(`/jira/kpis?lote=${encodeURIComponent(lote || '')}&periodo=${dias}`);
                const kpis = responseKPIs.data;

                console.log('üìä Dados do gr√°fico:', dadosGrafico);
                console.log('üìä KPIs do filtro:', kpis);

                // Atualizar gr√°fico
                if (chamadosChart && dadosGrafico) {
                    chamadosChart.data.labels = dadosGrafico.labels || [];
                    chamadosChart.data.datasets[0].data = dadosGrafico.data || [];
                    chamadosChart.update();
                }

                // Atualizar m√©tricas do filtro
                document.getElementById('metric-total-aberto').textContent = kpis.totalAbertos || '0';
                document.getElementById('metric-total-finalizados').textContent = kpis.totalFinalizados || '0';

                const totalChamados = (kpis.totalAbertos || 0) + (kpis.totalFinalizados || 0);
                const indiceResolucao = totalChamados > 0
                    ? Math.round(((kpis.totalFinalizados || 0) / totalChamados) * 100)
                    : 0;
                document.getElementById('metric-indice-conclusao').textContent = `${indiceResolucao}%`;

                // Atualizar t√≠tulo
                const tituloLote = lote || 'Todos os lotes';
                document.getElementById('chart-title').textContent = `Gr√°fico de Chamados nos √∫ltimos ${dias} dias - ${tituloLote}`;

            } catch (error) {
                console.error('‚ùå Erro ao atualizar gr√°fico:', error);
            }
        }

        // Fun√ß√£o para atualizar tudo
        async function atualizarTudo() {
            console.log('üîÑ Iniciando atualiza√ß√£o completa...');

            // Mostrar loading nos KPIs
            document.getElementById('kpi-lote-mais-chamados').textContent = 'Carregando...';
            document.getElementById('kpi-total-aberto').textContent = 'Carregando...';
            document.getElementById('kpi-resolvidos-24').textContent = 'Carregando...';
            document.getElementById('kpi-tempo-medio').textContent = 'Carregando...';

            try {
                // Executar atualiza√ß√µes em paralelo
                await Promise.all([
                    atualizarKPIsGlobais(),
                    atualizarTabelaChamados(),
                    atualizarGrafico()
                ]);

                console.log('‚úÖ Atualiza√ß√£o completa finalizada');
            } catch (error) {
                console.error('‚ùå Erro na atualiza√ß√£o completa:', error);
            }
        }

        // Inicializa√ß√£o quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Inicializando dashboard...');

            // Inicializar Chart.js
            const ctx = document.getElementById('chamadosChart').getContext('2d');
            chamadosChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Quantidade de chamados',
                        data: [],
                        borderColor: '#4eb5f1',
                        backgroundColor: 'rgba(78, 181, 241, 0.2)',
                        tension: 0.4,
                        pointBackgroundColor: '#4eb5f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });

            // Event listeners
            document.querySelectorAll('.periodo-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.periodo-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    atualizarGrafico();
                });
            });

            document.getElementById('lote').addEventListener('change', atualizarGrafico);

            // Carregar dados iniciais
            try {
                await carregarLotes();
                await atualizarTudo();
                console.log('‚úÖ Dashboard inicializado com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
            }

            // Auto-refresh a cada 5 minutos
            setInterval(() => {
                console.log('üîÑ Auto-refresh executado');
                atualizarKPIsGlobais();
                atualizarTabelaChamados();
            }, 5 * 60 * 1000);
        });
    </script>
</body>

</html>