<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerente de Segurança</title>
    <link rel="stylesheet" href="../css/monitoramento.css" />
    <link rel="website icon" type="png" href="../assets/img/logoAllSet.png" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
     <script src="../js/sessao.js"></script>
  <!-- parte do modal -->
     <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
</head>
<body>
  <div class="layout">
    <!-- LADO ESQUERDO FIXO -->
    <div class="secao-side">
      <div class="botao-side-bar">
        <div class="logo"><span>AS</span></div>
        <div id="menu-bar" class="fas fa-bars"></div>
      </div>
    </div>

    <main class="conteudo-principal">
      <div class="titulo_dash"> <span>VISÃO GERAL</span></div>
      <div class="pai_container">
        <div class="filho_container">
            <div class="kpi_saude">
              <span class="titulo_saude">Desempenho Atual da Operação (%) </span>
              <span id="valor_saude" class="valor_saude"></span>
            </div>
            <div class="carros_container">
                <div class="irmao_carro">
                  <div class="titulo_grafico_bar">
                    <h2 style="text-align:center; color:#1f3c88;">Fluxo em tempo real</h2>
                  </div>
                    <div class="div_grafico_tempo_real">
                      <canvas id="fluxoChart"></canvas>
                    </div>
                </div>
                <div class="irmao_carro_baixo">
                  <div class="pop_alerta">
                    <div class="topo_alerta">
                      <span>LOTE CRÍTICO</span>
                    </div>
                    <div class="meio_alerta">
                      <span class="nome_lote">Lote 001</span>
                      <span class="quantidade_alerta">7 ALERTAS GRAVES</span>
                      <span>Último alerta</span>
                      <span class="data_alerta">2025-05-25 08:59</span>
                    </div>
                  </div>
                  <div class="bar_componentes">
                    <div class="div_grafico_componentes">
                      <canvas id="componente_char"></canvas>
                    </div>
                  </div>
                </div>
            </div>
        </div>
        <div class="irmao_container">
          <div class="content_irmao">
            <div class="kpi_container">
                <div class="kpi_1">
                    <div class="kpi_top"><span>total carros ativos</span></div>
                    <div class="kpi_mid"><span id="total_carro">350</span></div>
                </div>
                <div class="kpi_1">
                    <div class="kpi_top"><span>total alertas - últimas 6h</span></div>
                    <div class="kpi_mid"><span id="valor_kpi_alerta">19</span></div>
                </div>
            </div>
            <div class="content_lotes">
              <div class="titulo_lotes">
              <span>SELECIONAR LOTE</span>
              </div>
              <div class="tabela_container">
                <table class="tabela_lotes">
                  <thead>
                      <tr>
                      <th>Lote</th>
                      <th>Carros</th>
                      <th>Alertas</th>
                      <th>Graves</th>
                      </tr>
                  </thead>
                 <tbody>
                      <tr class="selecionado">
                      <td>Lote 001</td>
                     <td>50</td>
                     <td>8</td>
                     <td class="status_lote">7</td>
                     </tr>
                     <tr class="selecionado">
                     <td>Lote 002</td>
                     <td>20</td>
                     <td>6</td>
                     <td class="status_lote">5</td>
                     </tr>
                     <tr class="selecionado">
                     <td>Lote 003</td>
                     <td>50</td>
                     <td>3</td>
                     <td class="status_lote_medio">1</td>
                     </tr>
                     <tr class="selecionado">
                     <td>Lote 004</td>
                     <td>20</td>
                     <td>2</td>
                     <td class="status_lote_normal">0</td>
                     </tr>
                  </tbody>
             </table>
             </div>
             </div>
            </div>
         </div>
        </div>

    </main>
  </div>

  <div id="side-bar" class="side-bar">
    <div class="logo"><span>AllSet</span></div>
    <div class="boas-vindas">
      <img src="../assets/imgs/user.png" alt="" />
      <div class="textos-perfil">
        <span>Bem Vindo</span>
        <span id="b_usuario">Jordana</span>
      </div>
    </div>
    <div class="opcoes-bar">
      <a href="">Dashboard</a>
      <a href="">Sair</a>
    </div>
  </div>

  <!-- FUNDO ESCURO -->
  <div id="fundo-preto" class="fundo-preto"></div>

<script>
  let total_carro_kpi;
  let total_alertas_kpi;
  let valor_saude = 0;

  atualizarGrafico()
  // atualizar kpi total carro
  fetch("/seguranca/buscar_carros", {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
    },
  }).then((res) => res.json())
  .then((res) => {
    total_carro_kpi = res[0]['COUNT(id_carro)'];
    document.getElementById("total_carro").innerHTML = total_carro_kpi

    return fetch("/seguranca/buscar_alertas", {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
    },
  }).then((res) => res.json())
  .then((res) => {
    total_alertas_kpi = res[0]['COUNT(id_alerta)'];
    let porcentagem_alerta = (total_alertas_kpi / total_carro_kpi) * 100
    if (porcentagem_alerta >= 50){
      document.getElementById("valor_kpi_alerta").style.color = "red";
    } else {
      document.getElementById("valor_kpi_alerta").style.color = "green";
    }
    document.getElementById("valor_kpi_alerta").innerHTML = total_alertas_kpi
  }) 
  }) 
  .catch((erro) => {
    console.log("deu ruim buceta caralho")
  })




  // grafico em tempo real
const ctx = document.getElementById('fluxoChart').getContext('2d');

const fluxoData = {
  labels: [],
  datasets: [
    {
      label: 'carros sem alertas',
      backgroundColor: 'limegreen',
      data: [],
      barPercentage: 0.7,
      borderRadius: 6,
    },
    {
      label: 'alertas (médios)',
      backgroundColor: 'gold',
      data: [],
      barPercentage: 0.7,
      borderRadius: 6
    },
    {
      label: 'alertas (graves)',
      backgroundColor: 'red',
      data: [],
      barPercentage: 0.7,
      borderRadius: 6
    }
  ]
};

const fluxoChart = new Chart(ctx, {
  type: 'bar',
  data: fluxoData,
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top'
      }
    },
    scales: {
      x: {
        stacked: false,
        grid: {
          display: false
        },
        ticks: {
          autoSkip: false,
          maxRotation: 45,
          minRotation: 45
        }
      },
      y: {
        beginAtZero: true,
        stacked: false,
        grid: {
          display: false
        }
      }
    }
  }
});

function atualizarGrafico() {
    fetch('http://localhost:3333/seguranca/dados_tempo_real')
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                const ponto = data[0];

                if (fluxoChart.data.labels.length >= 6) {
                    fluxoChart.data.labels.shift();
                    fluxoChart.data.datasets[0].data.shift();
                    fluxoChart.data.datasets[1].data.shift();
                    fluxoChart.data.datasets[2].data.shift();
                }

                fluxoChart.data.labels.push(ponto.horario);
                fluxoChart.data.datasets[0].data.push(ponto.carros_sem_alertas);
                fluxoChart.data.datasets[1].data.push(ponto.alertas_medios);
                fluxoChart.data.datasets[2].data.push(ponto.alertas_graves);

                fluxoChart.update();


                  valor_saude = (ponto.carros_sem_alertas / total_carro_kpi) * 100
                  document.getElementById("valor_saude").innerHTML = valor_saude
                 if (valor_saude <= 50){
                    document.getElementById("valor_saude").style.color = "red"
                  } else if (valor_saude <= 75){
                    document.getElementById("valor_saude").style.color = "gold"
                  } else {
                    document.getElementById("valor_saude").style.color = "green"
                  }
                
            }
        })
        .catch(error => console.error('Erro ao buscar dados:', error));
}


setInterval(atualizarGrafico, 10000); 


    // grafico de barra do comoponente por alerta
const ctx2 = document.getElementById('componente_char').getContext('2d');
const componentes_char = new Chart(ctx2, {
  type: 'bar',
  data: {
    labels: ['cpu', 'ram', 'disco'],
    datasets: [
      {
        label: 'alertas (médios)',
        data: [54, 43, 30],
        backgroundColor: 'gold',
        borderRadius: 6,
        barPercentage: 0.9,
        categoryPercentage: 0.5
      },
      {
        label: 'alertas (críticos)',
        data: [68, 51, 32],
        backgroundColor: 'purple',
        borderRadius: 6,
        barPercentage: 0.9,
        categoryPercentage: 0.5
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top'
      },
      title: {
        display: true,
        text: 'Alertas por Componente (médio / crítico)\nSEMANAL'
      }
    },
    scales: {
      x: {
        grid: {
          display: false
        },
        title: {
          display: true,
          text: 'componente'
        }
      },
      y: {
        beginAtZero: true,
        title: {
          display: true,
          text: 'Valor'
        },
        grid: {
          display: false,
          color: '#e0e0e0'
        }
      }
    }
  }
});


    document.getElementById("menu-bar").addEventListener("click", function () {
      const sidebar = document.querySelector(".side-bar");
      const fundoPreto = document.querySelector(".fundo-preto");
      const isVisible = sidebar.classList.contains("show");

      if (!isVisible) {
        sidebar.style.display = "flex";
        fundoPreto.style.display = "block";
        void sidebar.offsetWidth;
        void fundoPreto.offsetWidth;
        sidebar.classList.add("show");
        fundoPreto.classList.add("show");
      } else {
        sidebar.classList.remove("show");
        fundoPreto.classList.remove("show");
        setTimeout(() => {
          sidebar.style.display = "none";
          fundoPreto.style.display = "none";
        }, 300);
      }
    });
  </script>
</body>
</html>
