var { listarArquivosPorPrefixo, buscarArquivo } = require("../services/s3Service");

async function buscarTodosJsonsDeCustos(req, res) {
  try {
    var arquivos = await listarArquivosPorPrefixo("bucket-teste-trusted-captura", "custos/");

    var jsonPromises = arquivos.map(obj =>
      buscarArquivo("bucket-teste-trusted-captura", obj.Key).then(conteudo => JSON.parse(conteudo))
    );

    var todosOsCustos = await Promise.all(jsonPromises);

    res.status(200).json(todosOsCustos);
  } catch (err) {
    console.error("Erro ao buscar arquivos de custos:", err);
    res.status(500).send("Erro ao buscar arquivos de custos");
  }
}

module.exports = { buscarTodosJsonsDeCustos };
